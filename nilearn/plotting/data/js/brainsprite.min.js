function brainsprite(e){function a(e,a){return e.imageSmoothingEnabled=a,e}var t={};return"boolean"==typeof(t=Object.assign({},{nanValue:!1,smooth:!1,flagValue:!1,colorBackground:"#000000",flagCoordinates:!1,origin:{X:0,Y:0,Z:0},voxelSize:1,affine:!1,heightColorBar:.04,sizeFont:.075,colorFont:"#FFFFFF",nbDecimals:3,crosshair:!1,colorCrosshair:"#0000FF",sizeCrosshair:.9,title:!1,numSlice:!1,radiological:!1,showLR:!1},e)).affine&&!1===t.affine&&(t.affine=[[t.voxelSize,0,0,-t.origin.X],[0,t.voxelSize,0,-t.origin.Y],[0,0,t.voxelSize,-t.origin.Z],[0,0,0,1]]),t.canvas=document.getElementById(e.canvas),t.context=t.canvas.getContext("2d"),t.context=a(t.context,t.smooth),t.canvasY=document.createElement("canvas"),t.contextY=t.canvasY.getContext("2d"),t.canvasZ=document.createElement("canvas"),t.contextZ=t.canvasZ.getContext("2d"),t.canvasRead=document.createElement("canvas"),t.contextRead=t.canvasRead.getContext("2d"),t.canvasRead.width=1,t.canvasRead.height=1,t.onclick=void 0!==e.onclick?e.onclick:"",t.flagCoordinates?t.spaceFont=.1:t.spaceFont=0,t.sprite=document.getElementById(e.sprite),t.nbCol=t.sprite.width/e.nbSlice.Y,t.nbRow=t.sprite.height/e.nbSlice.Z,t.nbSlice={X:void 0!==e.nbSlice.X?e.nbSlice.X:t.nbCol*t.nbRow,Y:e.nbSlice.Y,Z:e.nbSlice.Z},t.widthCanvas={X:0,Y:0,Z:0},t.heightCanvas={X:0,Y:0,Z:0,max:0},0==t.numSlice&&(t.numSlice={X:Math.floor(t.nbSlice.X/2),Y:Math.floor(t.nbSlice.Y/2),Z:Math.floor(t.nbSlice.Z/2)}),t.coordinatesSlice={X:0,Y:0,Z:0},t.planes={},t.planes.canvasMaster=document.createElement("canvas"),t.planes.contextMaster=t.planes.canvasMaster.getContext("2d"),e.overlay=void 0!==e.overlay&&e.overlay,e.overlay&&(t.overlay={},t.overlay.sprite=document.getElementById(e.overlay.sprite),t.overlay.nbCol=t.overlay.sprite.width/e.overlay.nbSlice.Y,t.overlay.nbRow=t.overlay.sprite.height/e.overlay.nbSlice.Z,t.overlay.nbSlice={X:void 0!==e.overlay.nbSlice.X?e.overlay.nbSlice.X:t.overlay.nbCol*t.overlay.nbRow,Y:e.overlay.nbSlice.Y,Z:e.overlay.nbSlice.Z},t.overlay.opacity=void 0!==e.overlay.opacity?e.overlay.opacity:1),e.colorMap=void 0!==e.colorMap&&e.colorMap,e.colorMap&&(t.colorMap={},t.colorMap.img=document.getElementById(e.colorMap.img),t.colorMap.min=e.colorMap.min,t.colorMap.max=e.colorMap.max,e.colorMap.hide=void 0!==e.colorMap.hide&&e.colorMap.hide,t.colorMap.canvas=document.createElement("canvas"),t.colorMap.context=t.colorMap.canvas.getContext("2d"),t.colorMap.canvas.width=t.colorMap.img.width,t.colorMap.canvas.height=t.colorMap.img.height,t.colorMap.context.drawImage(t.colorMap.img,0,0,t.colorMap.img.width,t.colorMap.img.height,0,0,t.colorMap.img.width,t.colorMap.img.height)),t.getValue=function(e,a){if(!a)return NaN;var t,n,i,l,o;for(i=a.canvas.width,l=NaN,o=1/0,xx=0;xx<i;xx++)t=a.context.getImageData(xx,0,1,1).data,(n=Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2))<o&&(l=xx,o=n);return l*(a.max-a.min)/(i-1)+a.min},t.updateValue=function(){var e={},a=[],n=[];if(t.overlay&&!t.nanValue)try{e.XW=Math.round(t.numSlice.X%t.nbCol),e.XH=Math.round((t.numSlice.X-e.XW)/t.nbCol),t.contextRead.fillStyle="#FFFFFF",t.contextRead.fillRect(0,0,1,1),t.contextRead.drawImage(t.overlay.sprite,e.XW*t.nbSlice.Y+t.numSlice.Y,e.XH*t.nbSlice.Z+t.nbSlice.Z-t.numSlice.Z-1,1,1,0,0,1,1),rgb=t.contextRead.getImageData(0,0,1,1).data,a=255==rgb[0]&&255==rgb[1]&&255==rgb[2],t.contextRead.fillStyle="#000000",t.contextRead.fillRect(0,0,1,1),t.contextRead.drawImage(t.overlay.sprite,e.XW*t.nbSlice.Y+t.numSlice.Y,e.XH*t.nbSlice.Z+t.nbSlice.Z-t.numSlice.Z-1,1,1,0,0,1,1),rgb=t.contextRead.getImageData(0,0,1,1).data,n=0==rgb[0]&&0==rgb[1]&&0==rgb[2],t.voxelValue=a&&n?NaN:t.getValue(rgb,t.colorMap)}catch(e){console.warn(e.message),rgb=0,t.nanValue=!0,t.voxelValue=NaN}else t.voxelValue=NaN},t.multiply=function(e,a){for(var t=e.length,n=e[0].length,i=(a.length,a[0].length),l=new Array(t),o=0;o<t;++o){l[o]=new Array(i);for(var c=0;c<i;++c){l[o][c]=0;for(var s=0;s<n;++s)l[o][c]+=e[o][s]*a[s][c]}}return l},t.updateCoordinates=function(){coordVoxel=t.multiply(t.affine,[[t.numSlice.X+1],[t.numSlice.Y+1],[t.numSlice.Z+1],[1]]),t.coordinatesSlice.X=coordVoxel[0],t.coordinatesSlice.Y=coordVoxel[1],t.coordinatesSlice.Z=coordVoxel[2]},t.init=function(){t.widthCanvas.X=Math.floor(t.canvas.parentElement.clientWidth*(t.nbSlice.Y/(2*t.nbSlice.X+t.nbSlice.Y))),t.widthCanvas.Y=Math.floor(t.canvas.parentElement.clientWidth*(t.nbSlice.X/(2*t.nbSlice.X+t.nbSlice.Y))),t.widthCanvas.Z=Math.floor(t.canvas.parentElement.clientWidth*(t.nbSlice.X/(2*t.nbSlice.X+t.nbSlice.Y))),t.widthCanvas.max=Math.max(t.widthCanvas.X,t.widthCanvas.Y,t.widthCanvas.Z),t.heightCanvas.X=Math.floor(t.widthCanvas.X*t.nbSlice.Z/t.nbSlice.Y),t.heightCanvas.Y=Math.floor(t.widthCanvas.Y*t.nbSlice.Z/t.nbSlice.X),t.heightCanvas.Z=Math.floor(t.widthCanvas.Z*t.nbSlice.Y/t.nbSlice.X),t.heightCanvas.max=Math.max(t.heightCanvas.X,t.heightCanvas.Y,t.heightCanvas.Z),t.canvas.width!=t.widthCanvas.X+t.widthCanvas.Y+t.widthCanvas.Z&&(t.canvas.width=t.widthCanvas.X+t.widthCanvas.Y+t.widthCanvas.Z,t.canvas.height=Math.round((1+t.spaceFont)*t.heightCanvas.max),t.context=a(t.context,t.smooth)),t.sizeFontPixels=Math.round(t.sizeFont*t.heightCanvas.max),t.context.font=t.sizeFontPixels+"px Arial",t.planes.canvasMaster.width=t.sprite.width,t.planes.canvasMaster.height=t.sprite.height,t.planes.contextMaster.globalAlpha=1,t.planes.contextMaster.drawImage(t.sprite,0,0,t.sprite.width,t.sprite.height,0,0,t.sprite.width,t.sprite.height),t.overlay&&(t.planes.contextMaster.globalAlpha=t.overlay.opacity,t.planes.contextMaster.drawImage(t.overlay.sprite,0,0,t.overlay.sprite.width,t.overlay.sprite.height,0,0,t.sprite.width,t.sprite.height)),t.planes.canvasX=document.createElement("canvas"),t.planes.contextX=t.planes.canvasX.getContext("2d"),t.planes.canvasX.width=t.nbSlice.Y,t.planes.canvasX.height=t.nbSlice.Z,t.planes.canvasY=document.createElement("canvas"),t.planes.contextY=t.planes.canvasY.getContext("2d"),t.planes.canvasY.width=t.nbSlice.X,t.planes.canvasY.height=t.nbSlice.Z,t.planes.canvasZ=document.createElement("canvas"),t.planes.contextZ=t.planes.canvasZ.getContext("2d"),t.planes.canvasZ.width=t.nbSlice.X,t.planes.canvasZ.height=t.nbSlice.Y,t.planes.contextZ.rotate(-Math.PI/2),t.planes.contextZ.translate(-t.nbSlice.Y,0),t.updateValue(),t.updateCoordinates(),t.numSlice.X=Math.round(t.numSlice.X),t.numSlice.Y=Math.round(t.numSlice.Y),t.numSlice.Z=Math.round(t.numSlice.Z)},t.draw=function(e,a){var n,i,l={},o={X:"",Y:"",Z:""};switch(o.X=Math.ceil((1-t.sizeCrosshair)*t.nbSlice.X/2),o.Y=Math.ceil((1-t.sizeCrosshair)*t.nbSlice.Y/2),o.Z=Math.ceil((1-t.sizeCrosshair)*t.nbSlice.Z/2),a){case"X":l.XW=t.numSlice.X%t.nbCol,l.XH=(t.numSlice.X-l.XW)/t.nbCol,t.planes.contextX.drawImage(t.planes.canvasMaster,l.XW*t.nbSlice.Y,l.XH*t.nbSlice.Z,t.nbSlice.Y,t.nbSlice.Z,0,0,t.nbSlice.Y,t.nbSlice.Z),t.crosshair&&(t.planes.contextX.fillStyle=t.colorCrosshair,t.planes.contextX.fillRect(t.numSlice.Y,o.Z,1,t.nbSlice.Z-2*o.Z),t.planes.contextX.fillRect(o.Y,t.nbSlice.Z-t.numSlice.Z-1,t.nbSlice.Y-2*o.Y,1)),t.context.fillStyle=t.colorBackground,t.context.fillRect(0,0,t.widthCanvas.X,t.canvas.height),t.context.drawImage(t.planes.canvasX,0,0,t.nbSlice.Y,t.nbSlice.Z,0,(t.heightCanvas.max-t.heightCanvas.X)/2,t.widthCanvas.X,t.heightCanvas.X),t.title&&(t.context.fillStyle=t.colorFont,t.context.fillText(t.title,Math.round(t.widthCanvas.X/10),Math.round(t.heightCanvas.max*t.heightColorBar+1/4*t.sizeFontPixels))),t.flagValue&&(value="value = "+Number.parseFloat(t.voxelValue).toPrecision(t.nbDecimals).replace(/0+$/,""),valueWidth=t.context.measureText(value).width,t.context.fillStyle=t.colorFont,t.context.fillText(value,Math.round(t.widthCanvas.X/10),Math.round(t.heightCanvas.max*t.heightColorBar*2+3/4*t.sizeFontPixels))),t.flagCoordinates&&(n="x = "+Math.round(t.coordinatesSlice.X),i=t.context.measureText(n).width,t.context.fillStyle=t.colorFont,t.context.fillText(n,t.widthCanvas.X/2-i/2,Math.round(t.canvas.height-t.sizeFontPixels/2)));break;case"Y":for(t.context.fillStyle=t.colorBackground,t.context.fillRect(t.widthCanvas.X,0,t.widthCanvas.Y,t.canvas.height),xx=0;xx<t.nbSlice.X;xx++)posW=xx%t.nbCol,posH=(xx-posW)/t.nbCol,t.planes.contextY.drawImage(t.planes.canvasMaster,posW*t.nbSlice.Y+t.numSlice.Y,posH*t.nbSlice.Z,1,t.nbSlice.Z,xx,0,1,t.nbSlice.Z);if(t.crosshair&&(t.planes.contextY.fillStyle=t.colorCrosshair,t.planes.contextY.fillRect(t.numSlice.X,o.Z,1,t.nbSlice.Z-2*o.Z),t.planes.contextY.fillRect(o.X,t.nbSlice.Z-t.numSlice.Z-1,t.nbSlice.X-2*o.X,1)),t.context.drawImage(t.planes.canvasY,0,0,t.nbSlice.X,t.nbSlice.Z,t.widthCanvas.X,(t.heightCanvas.max-t.heightCanvas.Y)/2,t.widthCanvas.Y,t.heightCanvas.Y),t.colorMap&&!t.colorMap.hide&&(t.context.drawImage(t.colorMap.img,0,0,t.colorMap.img.width,1,Math.round(t.widthCanvas.X+.2*t.widthCanvas.Y),Math.round(t.heightCanvas.max*t.heightColorBar/2),Math.round(.6*t.widthCanvas.Y),Math.round(t.heightCanvas.max*t.heightColorBar)),t.context.fillStyle=t.colorFont,label_min=Number.parseFloat(t.colorMap.min).toPrecision(t.nbDecimals).replace(/0+$/,""),label_max=Number.parseFloat(t.colorMap.max).toPrecision(t.nbDecimals).replace(/0+$/,""),t.context.fillText(label_min,t.widthCanvas.X+.2*t.widthCanvas.Y-t.context.measureText(label_min).width/2,Math.round(t.heightCanvas.max*t.heightColorBar*2+3/4*t.sizeFontPixels)),t.context.fillText(label_max,t.widthCanvas.X+.8*t.widthCanvas.Y-t.context.measureText(label_max).width/2,Math.round(t.heightCanvas.max*t.heightColorBar*2+3/4*t.sizeFontPixels))),t.flagCoordinates&&(t.context.font=t.sizeFontPixels+"px Arial",t.context.fillStyle=t.colorFont,n="y = "+Math.round(t.coordinatesSlice.Y),i=t.context.measureText(n).width,t.context.fillText(n,t.widthCanvas.X+t.widthCanvas.Y/2-i/2,Math.round(t.canvas.height-t.sizeFontPixels/2))),void 0!==t.showLR&&t.showLR){var c=t.radiological||!1,s=Math.round(1*t.sizeFontPixels),r=Math.round(.22*t.canvas.height),h=t.context.font,d=t.context.textAlign,v=t.context.textBaseline;t.context.font=s+"px Arial",t.context.textAlign="center",t.context.textBaseline="middle",t.context.fillStyle=t.colorFont;var x=c?"R":"L",m=c?"L":"R";const e=.05,a=t.widthCanvas.Y*e;t.context.fillText(x,t.widthCanvas.X+a,r),t.context.fillText(m,t.widthCanvas.X+t.widthCanvas.Y-a,r),t.context.font=h,t.context.textAlign=d,t.context.textBaseline=v}break;case"Z":for(t.context.fillStyle=t.colorBackground,t.context.fillRect(t.widthCanvas.X+t.widthCanvas.Y,0,t.widthCanvas.Z,t.canvas.height),xx=0;xx<t.nbSlice.X;xx++)posW=xx%t.nbCol,posH=(xx-posW)/t.nbCol,t.planes.contextZ.drawImage(t.planes.canvasMaster,posW*t.nbSlice.Y,posH*t.nbSlice.Z+t.nbSlice.Z-t.numSlice.Z-1,t.nbSlice.Y,1,0,xx,t.nbSlice.Y,1);if(t.crosshair&&(t.planes.contextZ.fillStyle=t.colorCrosshair,t.planes.contextZ.fillRect(o.Y,t.numSlice.X,t.nbSlice.Y-2*o.Y,1),t.planes.contextZ.fillRect(t.numSlice.Y,o.X,1,t.nbSlice.X-2*o.X)),t.context.drawImage(t.planes.canvasZ,0,0,t.nbSlice.X,t.nbSlice.Y,t.widthCanvas.X+t.widthCanvas.Y,(t.heightCanvas.max-t.heightCanvas.Z)/2,t.widthCanvas.Z,t.heightCanvas.Z),t.flagCoordinates&&(n="z = "+Math.round(t.coordinatesSlice.Z),i=t.context.measureText(n).width,t.context.fillStyle=t.colorFont,t.context.fillText(n,t.widthCanvas.X+t.widthCanvas.Y+t.widthCanvas.Z/2-i/2,Math.round(t.canvas.height-t.sizeFontPixels/2))),void 0!==t.showLR&&t.showLR){c=t.radiological||!1,s=Math.round(1*t.sizeFontPixels),r=Math.round(.22*t.canvas.height),h=t.context.font,d=t.context.textAlign,v=t.context.textBaseline;t.context.font=s+"px Arial",t.context.textAlign="center",t.context.textBaseline="middle",t.context.fillStyle=t.colorFont;x=c?"R":"L",m=c?"L":"R";const e=.05,a=t.widthCanvas.Z*e;t.context.fillText(x,t.widthCanvas.X+t.widthCanvas.Y+a,r),t.context.fillText(m,t.widthCanvas.X+t.widthCanvas.Y+t.widthCanvas.Z-a,r),t.context.font=h,t.context.textAlign=d,t.context.textBaseline=v}}},t.clickBrain=function(e){var a,n,i=t.canvas.getBoundingClientRect(),l=e.clientX-i.left,o=e.clientY-i.top;l<t.widthCanvas.X?(a=Math.round((t.nbSlice.Y-1)*(l/t.widthCanvas.X)),n=Math.round((t.nbSlice.Z-1)*((t.heightCanvas.max+t.heightCanvas.X)/2-o)/t.heightCanvas.X),t.numSlice.Y=Math.max(Math.min(a,t.nbSlice.Y-1),0),t.numSlice.Z=Math.max(Math.min(n,t.nbSlice.Z-1),0)):l<t.widthCanvas.X+t.widthCanvas.Y?(l-=t.widthCanvas.X,sx=Math.round((t.nbSlice.X-1)*(l/t.widthCanvas.Y)),n=Math.round((t.nbSlice.Z-1)*((t.heightCanvas.max+t.heightCanvas.X)/2-o)/t.heightCanvas.X),t.numSlice.X=Math.max(Math.min(sx,t.nbSlice.X-1),0),t.numSlice.Z=Math.max(Math.min(n,t.nbSlice.Z-1),0)):(l=l-t.widthCanvas.X-t.widthCanvas.Y,sx=Math.round((t.nbSlice.X-1)*(l/t.widthCanvas.Z)),a=Math.round((t.nbSlice.Y-1)*((t.heightCanvas.max+t.heightCanvas.Z)/2-o)/t.heightCanvas.Z),t.numSlice.X=Math.max(Math.min(sx,t.nbSlice.X-1),0),t.numSlice.Y=Math.max(Math.min(a,t.nbSlice.Y-1),0)),t.updateValue(),t.updateCoordinates(),t.drawAll(),t.onclick&&t.onclick(e)},t.drawAll=function(){t.draw(t.numSlice.X,"X"),t.draw(t.numSlice.Y,"Y"),t.draw(t.numSlice.Z,"Z")},t.canvas.addEventListener("click",t.clickBrain,!1),t.canvas.addEventListener("mousedown",(function(e){t.canvas.addEventListener("mousemove",t.clickBrain,!1)}),!1),t.canvas.addEventListener("mouseup",(function(e){t.canvas.removeEventListener("mousemove",t.clickBrain,!1)}),!1),t.sprite.addEventListener("load",(function(){t.init(),t.drawAll()})),t.overlay&&t.overlay.sprite.addEventListener("load",(function(){t.init(),t.drawAll()})),t.init(),t.drawAll(),t}
