/*! brainsprite v0.15.0 */
function displayFloat(e,t){const n=parseFloat(e).toFixed(t);return n.indexOf(".")===-1?n+".":n.replace(/0+$/,"")}function initBrain(e){const n=Object.assign({},{smooth:!1,flagValue:!1,colorBackground:"#000000",flagCoordinates:!1,origin:{X:0,Y:0,Z:0},voxelSize:1,affine:!1,heightColorBar:.04,sizeFont:.075,colorFont:"#FFFFFF",nbDecimals:3,crosshair:!1,colorCrosshair:"#0000FF",sizeCrosshair:.9,title:!1,numSlice:!1,onclick:"",radiological:!1,showLR:!0},e);return typeof n.affine=="boolean"&&n.affine===!1&&(n.affine=[[n.voxelSize,0,0,-n.origin.X],[0,n.voxelSize,0,-n.origin.Y],[0,0,n.voxelSize,-n.origin.Z],[0,0,0,1]]),n.flagCoordinates?n.spaceFont=.1:n.spaceFont=0,n.coordinatesSlice={X:0,Y:0,Z:0},n.widthCanvas={X:0,Y:0,Z:0,max:0},n.heightCanvas={X:0,Y:0,Z:0,max:0},n}function initCanvas(e,t){return e.canvas=document.getElementById(t),e.context=e.canvas.getContext("2d"),e.context.imageSmoothingEnabled=e.smooth,e.canvasY=document.createElement("canvas"),e.contextY=e.canvasY.getContext("2d"),e.canvasZ=document.createElement("canvas"),e.contextZ=e.canvasZ.getContext("2d"),e.canvasRead=document.createElement("canvas"),e.contextRead=e.canvasRead.getContext("2d"),e.canvasRead.width=1,e.canvasRead.height=1,e.planes={},e.planes.canvasMaster=document.createElement("canvas"),e.planes.contextMaster=e.planes.canvasMaster.getContext("2d"),e}function initSprite(e,t,n){return e.sprite=document.getElementById(t),e.nbCol=e.sprite.width/n.Y,e.nbRow=e.sprite.height/n.Z,e.nbSlice={X:typeof n.X<"u"?n.X:e.nbCol*e.nbRow,Y:n.Y,Z:n.Z},e.numSlice===!1&&(e.numSlice={X:Math.floor(e.nbSlice.X/2),Y:Math.floor(e.nbSlice.Y/2),Z:Math.floor(e.nbSlice.Z/2)}),e}function initOverlay(e,t,n){return e.overlay.opacity=typeof e.overlay.opacity<"u"?e.overlay.opacity:1,e.overlay.sprite=document.getElementById(t),e.overlay.nbCol=e.overlay.sprite.width/n.Y,e.overlay.nbRow=e.overlay.sprite.height/n.Z,e.overlay.nbSlice={X:typeof n.X<"u"?n.X:e.overlay.nbCol*e.overlay.nbRow,Y:n.Y,Z:n.Z},e}function initColorMap(e){return e.hide=typeof e.hide<"u"?e.hide:!1,e.img=document.getElementById(e.img),e.canvas=document.createElement("canvas"),e.context=e.canvas.getContext("2d"),e.canvas.width=e.img.width,e.canvas.height=e.img.height,e.context.drawImage(e.img,0,0,e.img.width,e.img.height,0,0,e.img.width,e.img.height),e}function brainsprite(e){let t=initBrain(e);t=initCanvas(t,e.canvas),t=initSprite(t,e.sprite,e.nbSlice),e.overlay&&(t=initOverlay(t,e.overlay.sprite,e.overlay.nbSlice)),e.colorMap&&(t.colorMap=initColorMap(e.colorMap));const n=function(l,a){if(!a)return NaN;let i=NaN,o=1/0;const c=a.canvas.width,d=a.context.getImageData(0,0,c,1).data;for(let s=0;s<c;s++){const r=Math.abs(d[s*4]-l[0])+Math.abs(d[s*4+1]-l[1])+Math.abs(d[s*4+2]-l[2]);r<o&&(i=s,o=r)}return i*(a.max-a.min)/(c-1)+a.min},Y=function(){const l={};if(t.overlay&&!t.nanValue)try{l.XW=Math.round(t.numSlice.X%t.nbCol),l.XH=Math.round((t.numSlice.X-l.XW)/t.nbCol),t.contextRead.clearRect(0,0,1,1),t.contextRead.drawImage(t.overlay.sprite,l.XW*t.nbSlice.Y+t.numSlice.Y,l.XH*t.nbSlice.Z+t.nbSlice.Z-t.numSlice.Z-1,1,1,0,0,1,1);const a=t.contextRead.getImageData(0,0,1,1).data;a[3]===0?t.voxelValue=NaN:t.voxelValue=n(a,t.colorMap)}catch(a){console.warn(a.message),t.nanValue=!0,t.voxelValue=NaN}else t.voxelValue=NaN},M=function(l,a,i){for(let o=0;o<3;++o)l[o]=i[0]*a[o][0]+i[1]*a[o][1]+i[2]*a[o][2]+i[3]*a[o][3]},C=[0,0,0],Z=function(){M(C,t.affine,[t.numSlice.X+1,t.numSlice.Y+1,t.numSlice.Z+1,1]),t.coordinatesSlice.X=C[0],t.coordinatesSlice.Y=C[1],t.coordinatesSlice.Z=C[2]};return t.init=function(){const l=t.nbSlice.X,a=t.nbSlice.Y,i=t.nbSlice.Z;t.resize(),t.planes.canvasMaster.width=t.sprite.width,t.planes.canvasMaster.height=t.sprite.height,t.planes.contextMaster.globalAlpha=1,t.planes.contextMaster.drawImage(t.sprite,0,0,t.sprite.width,t.sprite.height,0,0,t.sprite.width,t.sprite.height),t.overlay&&(t.planes.contextMaster.globalAlpha=t.overlay.opacity,t.planes.contextMaster.drawImage(t.overlay.sprite,0,0,t.overlay.sprite.width,t.overlay.sprite.height,0,0,t.sprite.width,t.sprite.height)),t.planes.canvasX=document.createElement("canvas"),t.planes.contextX=t.planes.canvasX.getContext("2d"),t.planes.canvasX.width=a,t.planes.canvasX.height=i,t.planes.canvasY=document.createElement("canvas"),t.planes.contextY=t.planes.canvasY.getContext("2d"),t.planes.canvasY.width=l,t.planes.canvasY.height=i,t.planes.canvasZ=document.createElement("canvas"),t.planes.contextZ=t.planes.canvasZ.getContext("2d"),t.planes.canvasZ.width=l,t.planes.canvasZ.height=a,t.planes.contextZ.rotate(-Math.PI/2),t.planes.contextZ.translate(-a,0),Y(),Z(),t.numSlice.X=Math.round(t.numSlice.X),t.numSlice.Y=Math.round(t.numSlice.Y),t.numSlice.Z=Math.round(t.numSlice.Z)},t.resize=function(){const l=t.canvas.parentElement.clientWidth,a=t.nbSlice.X,i=t.nbSlice.Y,o=t.nbSlice.Z,c=Math.floor(l*(i/(2*a+i))),d=Math.floor(l*(a/(2*a+i))),s=Math.floor(l*(a/(2*a+i)));if(c===t.widthCanvas.X&&d===t.widthCanvas.Y&&s===t.widthCanvas.Z)return!1;t.widthCanvas.X=c,t.widthCanvas.Y=d,t.widthCanvas.Z=s,t.widthCanvas.max=Math.max(c,d,s),t.heightCanvas.X=Math.floor(t.widthCanvas.X*o/i),t.heightCanvas.Y=Math.floor(t.widthCanvas.Y*o/a),t.heightCanvas.Z=Math.floor(t.widthCanvas.Z*i/a),t.heightCanvas.max=Math.max(t.heightCanvas.X,t.heightCanvas.Y,t.heightCanvas.Z);const r=t.widthCanvas.X+t.widthCanvas.Y+t.widthCanvas.Z;return t.canvas.width!==r&&(t.canvas.width=r,t.canvas.height=Math.round((1+t.spaceFont)*t.heightCanvas.max),t.context.imageSmoothingEnabled=t.smooth),t.sizeFontPixels=Math.round(t.sizeFont*t.heightCanvas.max),t.context.font=t.sizeFontPixels+"px Arial",!0},t.draw=function(l,a){const i={};let o,c;const d=Math.ceil((1-t.sizeCrosshair)*t.nbSlice.X/2),s=Math.ceil((1-t.sizeCrosshair)*t.nbSlice.Y/2),r=Math.ceil((1-t.sizeCrosshair)*t.nbSlice.Z/2),u=t.nbSlice.Y,f=t.nbSlice.Z;let v;switch(a){case"X":if(i.XW=t.numSlice.X%t.nbCol,i.XH=(t.numSlice.X-i.XW)/t.nbCol,t.planes.contextX.drawImage(t.planes.canvasMaster,i.XW*u,i.XH*f,u,f,0,0,u,f),t.crosshair&&(t.planes.contextX.fillStyle=t.colorCrosshair,t.planes.contextX.fillRect(t.numSlice.Y,r,1,f-2*r),t.planes.contextX.fillRect(s,f-t.numSlice.Z-1,u-2*s,1)),t.context.fillStyle=t.colorBackground,t.context.fillRect(0,0,t.widthCanvas.X,t.canvas.height),t.context.drawImage(t.planes.canvasX,0,0,u,f,0,(t.heightCanvas.max-t.heightCanvas.X)/2,t.widthCanvas.X,t.heightCanvas.X),t.title&&(t.context.fillStyle=t.colorFont,t.context.fillText(t.title,Math.round(t.widthCanvas.X/10),Math.round(t.heightCanvas.max*t.heightColorBar+t.sizeFontPixels/4))),t.flagValue){const h=isNaN(t.voxelValue)?"no value":"value = "+displayFloat(t.voxelValue,t.nbDecimals);t.context.fillStyle=t.colorFont,t.context.fillText(h,Math.round(t.widthCanvas.X/10),Math.round(t.heightCanvas.max*t.heightColorBar*2+3/4*t.sizeFontPixels))}t.flagCoordinates&&(o="x = "+Math.round(t.coordinatesSlice.X),c=t.context.measureText(o).width,t.context.fillStyle=t.colorFont,t.context.fillText(o,t.widthCanvas.X/2-c/2,Math.round(t.canvas.height-t.sizeFontPixels/2)));break;case"Y":for(t.context.fillStyle=t.colorBackground,t.context.fillRect(t.widthCanvas.X,0,t.widthCanvas.Y,t.canvas.height),v=0;v<t.nbSlice.X;v++){const h=v%t.nbCol,x=(v-h)/t.nbCol;t.planes.contextY.drawImage(t.planes.canvasMaster,h*t.nbSlice.Y+t.numSlice.Y,x*t.nbSlice.Z,1,t.nbSlice.Z,v,0,1,t.nbSlice.Z)}if(t.crosshair&&(t.planes.contextY.fillStyle=t.colorCrosshair,t.planes.contextY.fillRect(t.numSlice.X,r,1,t.nbSlice.Z-2*r),t.planes.contextY.fillRect(d,t.nbSlice.Z-t.numSlice.Z-1,t.nbSlice.X-2*d,1)),t.context.drawImage(t.planes.canvasY,0,0,t.nbSlice.X,t.nbSlice.Z,t.widthCanvas.X,(t.heightCanvas.max-t.heightCanvas.Y)/2,t.widthCanvas.Y,t.heightCanvas.Y),t.colorMap&&!t.colorMap.hide){t.context.drawImage(t.colorMap.img,0,0,t.colorMap.img.width,1,Math.round(t.widthCanvas.X+t.widthCanvas.Y*.2),Math.round(t.heightCanvas.max*t.heightColorBar/2),Math.round(t.widthCanvas.Y*.6),Math.round(t.heightCanvas.max*t.heightColorBar)),t.context.fillStyle=t.colorFont;const h=displayFloat(t.colorMap.min,t.nbDecimals),x=displayFloat(t.colorMap.max,t.nbDecimals);t.context.fillText(h,t.widthCanvas.X+t.widthCanvas.Y*.2-t.context.measureText(h).width/2,Math.round(t.heightCanvas.max*t.heightColorBar*2+3/4*t.sizeFontPixels)),t.context.fillText(x,t.widthCanvas.X+t.widthCanvas.Y*.8-t.context.measureText(x).width/2,Math.round(t.heightCanvas.max*t.heightColorBar*2+3/4*t.sizeFontPixels))}if(t.flagCoordinates&&(t.context.font=t.sizeFontPixels+"px Arial",t.context.fillStyle=t.colorFont,o="y = "+Math.round(t.coordinatesSlice.Y),c=t.context.measureText(o).width,t.context.fillText(o,t.widthCanvas.X+t.widthCanvas.Y/2-c/2,Math.round(t.canvas.height-t.sizeFontPixels/2))),t.showLR){const h=!!t.radiological,x=Math.round(.22*t.canvas.height),{font:m,textAlign:w,textBaseline:S}=t.context;t.context.font=`${t.sizeFontPixels}px Arial`,t.context.textAlign="center",t.context.textBaseline="middle",t.context.fillStyle=t.colorFont;const X=h?"R":"L",p=h?"L":"R",g=t.widthCanvas.Y*.05;t.context.fillText(X,t.widthCanvas.X+g,x),t.context.fillText(p,t.widthCanvas.X+t.widthCanvas.Y-g,x),t.context.font=m,t.context.textAlign=w,t.context.textBaseline=S}break;case"Z":for(t.context.fillStyle=t.colorBackground,t.context.fillRect(t.widthCanvas.X+t.widthCanvas.Y,0,t.widthCanvas.Z,t.canvas.height),v=0;v<t.nbSlice.X;v++){const h=v%t.nbCol,x=(v-h)/t.nbCol;t.planes.contextZ.drawImage(t.planes.canvasMaster,h*t.nbSlice.Y,x*t.nbSlice.Z+t.nbSlice.Z-t.numSlice.Z-1,t.nbSlice.Y,1,0,v,t.nbSlice.Y,1)}if(t.crosshair&&(t.planes.contextZ.fillStyle=t.colorCrosshair,t.planes.contextZ.fillRect(s,t.numSlice.X,t.nbSlice.Y-2*s,1),t.planes.contextZ.fillRect(t.numSlice.Y,d,1,t.nbSlice.X-2*d)),t.context.drawImage(t.planes.canvasZ,0,0,t.nbSlice.X,t.nbSlice.Y,t.widthCanvas.X+t.widthCanvas.Y,(t.heightCanvas.max-t.heightCanvas.Z)/2,t.widthCanvas.Z,t.heightCanvas.Z),t.flagCoordinates&&(o="z = "+Math.round(t.coordinatesSlice.Z),c=t.context.measureText(o).width,t.context.fillStyle=t.colorFont,t.context.fillText(o,t.widthCanvas.X+t.widthCanvas.Y+t.widthCanvas.Z/2-c/2,Math.round(t.canvas.height-t.sizeFontPixels/2))),t.showLR){const h=!!t.radiological,x=Math.round(.22*t.canvas.height),{font:m,textAlign:w,textBaseline:S}=t.context;t.context.font=`${t.sizeFontPixels}px Arial`,t.context.textAlign="center",t.context.textBaseline="middle",t.context.fillStyle=t.colorFont;const X=h?"R":"L",p=h?"L":"R",g=t.widthCanvas.Z*.05;t.context.fillText(X,t.widthCanvas.X+t.widthCanvas.Y+g,x),t.context.fillText(p,t.widthCanvas.X+t.widthCanvas.Y+t.widthCanvas.Z-g,x),t.context.font=m,t.context.textAlign=w,t.context.textBaseline=S}}},t.clickBrain=function(l){const a=t.canvas.getBoundingClientRect();let i=l.clientX-a.left;const o=l.clientY-a.top;let c,d;if(i<t.widthCanvas.X)c=Math.round((t.nbSlice.Y-1)*(i/t.widthCanvas.X)),d=Math.round((t.nbSlice.Z-1)*((t.heightCanvas.max+t.heightCanvas.X)/2-o)/t.heightCanvas.X),t.numSlice.Y=Math.max(Math.min(c,t.nbSlice.Y-1),0),t.numSlice.Z=Math.max(Math.min(d,t.nbSlice.Z-1),0);else if(i<t.widthCanvas.X+t.widthCanvas.Y){i=i-t.widthCanvas.X;const s=Math.round((t.nbSlice.X-1)*(i/t.widthCanvas.Y)),r=Math.round((t.nbSlice.Z-1)*((t.heightCanvas.max+t.heightCanvas.X)/2-o)/t.heightCanvas.X);t.numSlice.X=Math.max(Math.min(s,t.nbSlice.X-1),0),t.numSlice.Z=Math.max(Math.min(r,t.nbSlice.Z-1),0)}else{i=i-t.widthCanvas.X-t.widthCanvas.Y;const s=Math.round((t.nbSlice.X-1)*(i/t.widthCanvas.Z)),r=Math.round((t.nbSlice.Y-1)*((t.heightCanvas.max+t.heightCanvas.Z)/2-o)/t.heightCanvas.Z);t.numSlice.X=Math.max(Math.min(s,t.nbSlice.X-1),0),t.numSlice.Y=Math.max(Math.min(r,t.nbSlice.Y-1),0)}Y(),Z(),t.drawAll(),t.onclick&&t.onclick(l)},t.drawAll=function(){t.draw(t.numSlice.X,"X"),t.draw(t.numSlice.Y,"Y"),t.draw(t.numSlice.Z,"Z")},t.canvas.addEventListener("click",t.clickBrain,!1),t.canvas.addEventListener("mousedown",function(){t.canvas.addEventListener("mousemove",t.clickBrain,!1)},!1),t.canvas.addEventListener("mouseup",function(){t.canvas.removeEventListener("mousemove",t.clickBrain,!1)},!1),t.sprite.addEventListener("load",function(){t.init(),t.drawAll()}),t.overlay&&t.overlay.sprite.addEventListener("load",function(){t.init(),t.drawAll()}),t.init(),t.drawAll(),window.addEventListener("resize",function(){t.resize()&&t.drawAll()}),t}
